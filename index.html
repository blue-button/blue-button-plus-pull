<!DOCTYPE html>

<html lang="en">
<head>
  <meta name="generator" content=
  "HTML Tidy for HTML5 (experimental) for Linux https://github.com/w3c/tidy-html5/tree/c63cc39">
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8">
  <meta charset="utf-8">

  <title>BlueButton+ Pull API, Dynamic Registration and Push User Authorization</title>
  <meta name="viewport" content=
  "width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content=""><!-- Le styles -->
  <link href="assets/css/bootstrap.css" rel="stylesheet">
  <link href="assets/css/bootstrap-responsive.css" rel=
  "stylesheet">
  <link href="assets/css/docs.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/gh-fork-ribbon.css">
  <!--[if IE]>
        <link rel="stylesheet" href="assets/css/gh-fork-ribbon.ie.css" />
    <![endif]-->
  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body data-spy="scroll" data-target=".bs-docs-sidebar" data-twttr-rendered="true">
  <div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
      <a href=
      "https://github.com/blue-button/blue-button-plus-pull">Fork me on
      GitHub</a>
    </div>
  </div><!-- Navbar
      ================================================== -->
  <!-- Subhead
      ================================================== -->

  <header class="jumbotron subhead" id="overview">
    <div class="container">
      <h1>BlueButton+ Pull API, Dynamic Registration and Push User Authorization</h1>

      <p class="lead">OAuth2 API for RESTful access to patient data and bootstrapping DIRECT-based information exchange</p>
    </div>
  </header>

  <div class="container">
    <!-- Docs nav
        ================================================== -->

    <div class="row">
      <div class="span3 bs-docs-sidebar">
        <ul class="nav nav-list bs-docs-sidenav" data-offset-top="200">
          <li>
            <a href="#registration"><i class=
            "icon-chevron-right"></i> <span class="label label-success">Common</span> App Registration</a>
          </li>

          <li class="sidenav-indent">
            <a href="#registration-open"><i class=
            "icon-chevron-right"></i> Open Registration</a>
          </li>

          <li class="sidenav-indent">
            <a href="#registration-trusted"><i class=
            "icon-chevron-right"></i> Trusted Registration</a>
          </li>

          <li>
            <a href="#authorization"><i class=
            "icon-chevron-right"></i> <span class="label label-info">Pull</span> App Authorization</a>
          </li>

          <li class="sidenav-indent">
            <a href="#authorization-code"><i class=
            "icon-chevron-right"></i> Authorization Code Grant</a>
          </li>

          <li class="sidenav-indent">
            <a href="#authorization-implicit"><i class=
            "icon-chevron-right"></i> Implicit Grant</a>
          </li>

          <li>
            <a href="#api"><i class="icon-chevron-right"></i>
            <span class="label label-info">Pull</span>  Clinical Data API (TODO)</a>
          </li>

          <li class="sidenav-indent">
            <a href="#api-summary"><i class=
            "icon-chevron-right"></i> Clinical Summary</a>
          </li>

          <li class="sidenav-indent">
            <a href="#api-search"><i class=
            "icon-chevron-right"></i> Document Search</a>
          </li>

          <li>
            <a href="#discovery"><i class="icon-chevron-right"></i>
             <span class="label label-success">Common</span> Endpoint Discovery </a>
          </li>

          <li class="sidenav-indent">
            <a href="#discovery-trustbundle"><i class=
            "icon-chevron-right"></i> BB+ Trust Bundle</a>
          </li>

          <li class="sidenav-indent">
            <a href="#discovery-providers"><i class=
            "icon-chevron-right"></i> BB+ Providers</a>
          </li>

          <li class="sidenav-indent">
            <a href="#discovery-apps"><i class=
            "icon-chevron-right"></i> BB+ Apps</a>
          </li>

          <li>
            <a href="#push-authorization"><i class=
            "icon-chevron-right"></i> <span class="label label-warning">Push</span>  User Authorization</a>
          </li>
        </ul>
      </div>

      <div class="span9">
      
	<section id="explanation">
	  <div class="well alert-info">
	    <strong>Note:</strong> This page collects aspects applicable to both BB+  <span class="label label-warning">Push</span> (signed email transport) and BB+ <span class="label label-info">Pull</span> (HTTP RESTful transport) protocols. It is the goal of this proposal to re-use <span class="label label-success">Common</span> components between both classes of application, even though the underlying systems and protocols are orthoganol to each other. In this way, a system that wanted to implement both the Push and Pull mechaisms would be able to re-use the same code and patterns for common activities such as end-user authorization, dynamic client registration, and service discovery.
	  </div>
	</section>
      
        <section id="registration">
          <div class="page-header">
            <h1>App Registration <small>an up-front, partially-automated
            step</small> <span class="label label-success">Common</span></h1>

            <p>Before an app connects to a BlueButton+ provider,
            it registers with that provider as an OAuth2 Client.
            The registration process informs the provider what the
            app is called, where to find it, what permissions it
            might ask patients for, and how to display an
            authorization screen to patients.</p>

            <p>BB+ apps register with providers using <a href="http://tools.ietf.org/html/draft-ietf-oauth-dyn-reg">
            OAuth2 Dynamic Client Registration</a>. This guide
            walks through the process of registering a client using
            open registration, as well as an example of using
            trusted registration which leverages trust bundles.</p>

            <h2 id="registration-open">Open
            Registration</h2>BlueButton+ providers offer an open
            registration option. To register, an app issues an
            <code>https POST</code> to the registration endpoint,
            supplying registration parameters as a JSON object.

            <div class="well alert-info">
              <strong>Note</strong>: Open registration is
              appropriate for new and experimental apps, but
              patient-facing authorization screens should display a
              warning indicating that an app's identity has not
              been verified. To provide a higher level of
              assurance, apps can perform a Trusted Registration
              (described below).
            </div>

            <h3 id="registration-parameters">Registration
            Parameters</h3>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Type</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>client_name</code></td>

                <td><code>string</code></td>

                <td>Human-readable name of the Client to be
                presented to the user.</td>
              </tr>

              <tr>
                <td><code>client_uri</code></td>

                <td><code>string</code></td>

                <td>URL of the homepage of the Client.</td>
              </tr>

              <tr>
                <td><code>logo_uri</code></td>

                <td><code>string</code></td>

                <td>URL that references a logo for the Client. If
                present, the server SHOULD display this image to
                the end user during approval</td>
              </tr>

              <tr>
                <td><code>tos_uri</code></td>

                <td><code>string</code></td>

                <td>URL that points to a human-readable Terms of
                Service for the Client. The Authorization Server
                SHOULD display this URL to the End-User if it is
                given.</td>
              </tr>

              <tr>
                <td><code>redirect_uris</code></td>

                <td><code>array</code></td>

                <td>Array of redirect URIs for use in the
                Authorization Code and Implicit grant types. An
                Authorization Server SHOULD require registration of
                valid redirect URIs for all clients that use these
                grant types in order to protect against token and
                credential theft attacks.</td>
              </tr>

              <tr>
                <td><code>response_types</code></td>

                <td><code>array</code></td>

                <td>
                  Array of the OAuth 2.0 response types that the
                  Client may use.

                  <ul>
                    <li>public clients: <code>"token"</code> or
                    <code>"code"</code></li>

                    <li>confidential clients:
                    <code>"code"</code></li>
                  </ul>
                </td>
              </tr>

              <tr>
                <td><code>token_endpoint_auth_method</code></td>

                <td><code>string</code></td>

                <td>
                  The requested authentication type for the Token
                  Endpoint.

                  <ul>
                    <li>public clients: <code>"none"</code></li>

                    <li>confidential clients:
                    <code>"client_secret_basic"</code></li>
                  </ul>
                </td>
              </tr>

              <tr>
                <td><code>grant_types</code></td>

                <td><code>array</code></td>

                <td>
                  Array of OAuth 2.0 grant types that the Client
                  may use.

                  <ul>
                    <li>public clients:
                    <code>["implicit"]</code></li>

                    <li>confidential clients:
                    <code>["authorization_code"]</code></li>
                  </ul>
                </td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td><code>string</code></td>

                <td>Space separated list of scope values (as
                described in OAuth 2.0 Section 3.3 [RFC6749]) that
                the client is declaring that it may use when
                requesting access tokens. A valid BB+ scope must
                include <code>single-patient</code>, and may
                additionally include
                <code>http://siframework.org/ABBI/endpoint/search</code>
                and
                <code>http://siframework.org/ABBI/endpoint/summary</code></td>
              </tr>

              <tr>
                <td><code>contacts</code></td>

                <td><code>array</code></td>

                <td>Array of email addresses for people responsible
                for this Client. The Authorization Server MAY make
                these addresses available to end users for support
                requests for the Client. An Authorization Server
                MAY use these email addresses as identifiers for an
                administrative page for this client.</td>
              </tr>
            </table>

            <h3>Example Registration for a Public Client</h3>
            <pre class="prettyprint">
POST /register HTTP/1.1
Content-Type: application/json
Accept: application/json
Host: bbplus-provider.org

{
  "client_name": "Blood Pressure Grapher",
  "client_uri": "https://bpgrapher.org",
  "logo_uri": "http://bpgrapher.org/images/logo.png",
  "contacts": [
    "plot-master@bpgrapher.org"
  ],
  "tos_uri": "https://bpgrapher.org/tos",
  "redirect_uris": [
    "https://bpgrapher.org/after-auth"
  ],
  "response_types": ["token"],
  "grant_types": ["implicit"],
  "token_endpoint_auth_method": "none",
  "scope":  "single-patient http://siframework.org/ABBI/endpoint/summary"
} 
</pre>

            <h3>Example Registration for a Confidential Client</h3>
            <pre class="prettyprint">
POST /register HTTP/1.1
Content-Type: application/json
Accept: application/json
Host: bbplus-provider.org

{
  "client_name": "Blood Pressure Grapher",
  "client_uri": "https://bpgrapher.org",
  "logo_uri": "http://bpgrapher.org/images/logo.png",
  "contacts": [
    "plot-master@bpgrapher.org"
  ],
  "tos_uri": "https://bpgrapher.org/tos",
  "redirect_uris": [
    "https://bpgrapher.org/after-auth"
  ],
  "response_types": ["code"],
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "client_secret_basic",
  "scope":  "single-patient http://siframework.org/ABBI/endpoint/summary"
} 
</pre>

	    <p>The client will receive a unique <code>client_id</code> for that service provider, and will also receive a <code>registration_access_token</code> that it can use to maintain its registration there, as described in OAuth Dynamic Client Registration.</p>

            <h2 id="registration-trusted">Trusted Registration</h2>

            <p>In addition to open registration, BlueButton+
            providers support a Trusted Registration option. When
            performing a Trusted Registration, apps follow the
            protocol described above, with the addition of a
            bearer token from a Trust Bundle that the provder trusts.
            This trusted bearer token is a JSON Web Token signed with <a href=
            "http://tools.ietf.org/html/draft-jones-json-web-signature">
            JSON Web Signature</a> and is verifiable by the service provider.</p>

	    <p>Process:
	      <ol>
		<li>Client class is manually pre-registered with the Trust Bundle, getting a pre-registration token and fixing some subset of its claims, to be made discoverable via the apps.json discovery mechanism on the trust bundle</li>
		<li>Client instance presents the pre-registration token (using any valid mechanism from RFC6750) to the registration endpoint of the service provider (which is discoverable via the providers.json discovery mechanism).</li>
		<li>Service provider validates the pre-registration token by checking the signature against the public key of the trust bundle indicated by the <code>iss</code> field of the token and/or doing token introspection from the <code>iss</code>.</li>
		<li>Service provider does application discovery based on the <code>iss</code> and <code>sub</code> fields of the token to find the apps.json entry for this application</li>
		<li>Service provider compares any dynamically registered client metadata fields to any fixed value fields discovered in apps.json <i>NOTE: we need good string-comparison and validation rules to be written for this step</i></li>
		<li>Client instance receives a client_id and client_secret as well as a registration_access_token</li>
		<li>Client instance requests user authorization and tokens</li>
		<li>Client instance accesses protected services at service provider</li>
	      </ol>
	    </p>
            
            <div class="well alert-info">
              <strong>Note</strong>: The pre-registration process allows for classes of clients to be treated together with a somewhat higher level of trust than a fully-dynamically-registered client might have. All installed copies of a native application would be considered part of the same "class". However, since an OAuth <code>client_id</code> is unique and opaque to the pairing of a client and the service provider it is communicating with, even a single installation of an application (such as a web app) would effectively have multiple "instances" on the network, as it would have multiple <code>client_id</code>s when dealing with different service providers.
            </div>
            
            <h3>Pre-registration</h3>
            
            <p>First, the Client class is manually pre-registered with a Trust Bundle. This process may fix any of the client parameters listed above, such as the <code>client_name</code> and <code>redirect_uris</code>. All classes of a client will share any fixed parameters.
            </p>
            
            <p>The pre-registered client class will receive a "subject" identifier unique within the scope of the trust bundle, and a signed registration token with the following properties:
            
            <ul>
	      <li><code>iss</code>: issuer is the URL of the trust bundle provider</li>
	      <li><code>sub</code>: subject is an identifier from the trust bundle that uniquely identifies this class of clients. This <strong>should</strong> be the same as a client's homepage URI</li>
	      <li><code>iat</code>: timestamp of when this pre-registration information was last updated (and this token was issued)</li>
	      <li><code>exp</code>: optional timestamp of when this pre-registration token is no longer valid</li>
	      <li>asymmetrically signed by the trust bundle, signature can be validated from the trust bundle's published public key (published as a JWK)</li>
	    </ul>
            
            <p>All service providers within a trust bundle must be able to validate the signature and validity of any registration tokens. It's recommended (required?) that trust bundle providers publish a <a href="http://tools.ietf.org/html/draft-richer-oauth-introspection">token introspection endpoint</a> to facilitate this.            
            </p>
            
            <h3>Registration</h3>
            
            <p>This registration token is used by instances of the client during the initial call to the registration endpoint for each service provider. The service provider does application discovery (described in this document) based on the subject and issuer in the registration token to determine which client metadata fields have been set ahead of time by the pre-registration process. The Service provider will compare these pre-registered fields with any dynamically provided fields and determine the validity of the registration. 
            </p>
            
            <h3>Notes</h3>
            
            <div class="well alert-info">
	      <strong>Notes:</strong>
	      <ul>
	      <li>The application owner/developer is responsible for pre-registering with the trust bundle.</li>
    
                 <li>The service provider is responsible for matching dynamic registration claims with the pre-registered claims.</li>

                 <li>Client instances present the token that comes from the pre-registration process as part of a normal dynamic registration with a particular service provider.</li>

                 <li>This technique allows service providers to link together multiple instances of a client based on the tokens used during registration. Service providers are responsible for linking thse client instances together if they so desire. A service provider MAY re-use the same client_id for all instance, or it may issue different client_ids for each instance.</li>

                 <li>Clients are responsible (in all registration cases) for accepting and using the client_id issued to them by each service provider when talking to that service provider.</li>

                 <li>Even a web-server style client is going to need to get different client_id's from every service provider, which means that even a single installation of a client could have multiple "instances" as far as the network is concerned.</li>
            </div>

        </section>

        <section id="authorization">
          <div class="page-header">
            <h1>App Authorization <small>a runtime, patient-driven
            step</small> <span class="label label-info">Pull</span></h1>

            <p>BlueButton+ providers allow apps to obtain patient
            authorization to health data using standard OAuth2
            authorization flows. There are two authorization flows
            initially supported: Implcit Grant (appropriate only
            for public clients) and Authorization Code Grant
            (appropriate for public as well as confidential
            clients).</p>

            <p>Both flows follow the same basic pattern:</p>

            <ol>
              <li>App redirects the browser to a BlueButton+
              Provider's Authorization endpoint</li>

              <li>BB+ Provider authenticates patient and obtains
              authorization</li>

              <li>BB+ Provider redirects control back to App</li>
            </ol>

            <h2 id="authorization-code">Authorization Code Grant
            <small>for public or confidential clients</small></h2>

            <h3>1. App-to-Provider Redirection</h3>To initiate an
            Authorization Code Grant authorization, the app
            redirects the browser to a BlueButton+ provider's
            Authorization endpoint with the following URL
            parmeters:

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>response_type</code></td>

                <td>REQUIRED. Value MUST be set to
                <code>code</code>.</td>
              </tr>

              <tr>
                <td><code>client_id</code></td>

                <td>REQUIRED. The client identifier</td>
              </tr>

              <tr>
                <td><code>redirect_uri</code></td>

                <td>REQUIRED. Must match one of the client's
                pre-registered redirect URIs.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Must include
                <code>single-patient</code>, and may additionally
                include
                <code>http://siframework.org/ABBI/endpoint/search</code>
                and
                <code>http://siframework.org/ABBI/endpoint/summary</code></td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>RECOMMENDED. An opaque value used by the client
                to maintain state between the request and callback.
                The authorization server includes this value when
                redirecting the user-agent back to the client. The
                parameter SHOULD be used for preventing cross-site
                request forgery <span class="label label-warning">Should state be REQUIRED with a minimum level of entropy?</span></td>
              </tr>
            </table>

            <h5>Example App-to-Provider Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/authorize?
response_type=code&amp;
client_id=bp-grapher&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth&amp;
scope=single-patient%20http%3A%2F%2Fsiframework.org%2FABBI%2Fendpoint%2Fsummary&amp;
state=98wrghuwuogerg97

Host: bbplus-provider.org
</pre>

            <h3>2. Provider Authenticates Patient and Obtains
            Authorization</h3>The mechanism by which providers
            authenticate patients and obtain authorization is out
            of scope for this specification

            <h3>3. Provider-to-App Redirection</h3>

            <p>After a successful authorization step, the
            BlueButton+ provider redirects the browser to the app's
            <code>redirect_uri</code>, with the following
            parameters <strong>supplied in the query
            component</strong>.</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>code</code></td>

                <td>REQUIRED. The authorization code generated by
                the authorization server. The authorization code
                MUST expire shortly after it is issued to mitigate
                the risk of leaks.</td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>REQUIRED. The exact value received from the
                client.</td>
              </tr>
            </table>

            <h5>Example Provider-to-App Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/after-oauth?
code=j0j9midoe0r9gjwro83h974t8gifb&amp;
state=98wrghuwuogerg97

Host: bpgrapher.org
</pre>

            <h3>4. App exchanges authorization code for access
            token</h3>

            <p>After receiving an authorization code, the app
            issues a request to the BlueButton+ provider's
            <code>Token URI</code> to exchange the authorization
            code for an access token. The exchange includes the
            following parameters</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>grant_type</code></td>

                <td>REQUIRED. Fixed value:
                <code>authorization_code</code></td>
              </tr>

              <tr>
                <td><code>code</code></td>

                <td>REQUIRED. Code that an app can exchange for an
                access token.</td>
              </tr>

              <tr>
                <td><code>redirect_uri</code></td>

                <td>REQIRED. The same redirect_uri used in the
                initial authorization request</td>
              </tr>

              <tr>
                <td><code>client_id</code></td>

                <td>REQUIRED for public clients. May be omitted by
                confidential clients.</td>
              </tr>
            </table>

            <h5>Example Code-for-Token Exchange Request (Public
            Client)</h5>
            <pre class="prettyprint">
POST /token HTTP/1.1
Host: server.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;
code=j0j9midoe0r9gjwro83h974t8gifb&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth&amp;
client_id=bp-grapher 
</pre>

            <h5>Example Code-for-Token Exchange Request
            (Confidential Client)</h5>
            <pre class="prettyprint">
POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic {{TODO: client password auth example}}
Content-Type: application/x-www-form-urlencoded/token?

grant_type=authorization_code&amp;
code=j0j9midoe0r9gjwro83h974t8gifb&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth 
</pre>

            <p>The response is a JSON object containing the
            following parameters</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>access_token</code></td>

                <td>REQUIRED. The access token issued by the
                authorization server</td>
              </tr>

              <tr>
                <td><code>token_type</code></td>

                <td>REQUIRED. Fixed value: <code>bearer</code></td>
              </tr>

              <tr>
                <td><code>expires_in</code></td>

                <td>REQUIRED. The lifetime in seconds of the access
                token. For example, the value "3600" denotes that
                the access token will expire in one hour from the
                time the response was generated.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Scope of access authorized by the
                patient.</td>
              </tr>
            </table>

            <h5>Example Code-for-Token Exchange Response</h5>
            <pre class="prettyprint">
{
  "access_token": "i8hweunweunweofiwweoijewiwe",
  "token_type": "bearer",
  "expires_in": "3600",
  "scope": "single-patient http://siframework.org/ABBI/endpoint/summary"
} 
</pre>

            <h2 id="authorization-implicit">Implicit Grant
            <small>for public clients</small></h2>

            <h3>1. App-to-Provider Redirection</h3>To initiate an
            Implicit Grant authorization, the app redirects the
            browser to a BlueButton+ provider's Authorization
            endpoint with the following URL parmeters:

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>response_type</code></td>

                <td>REQUIRED. Value MUST be set to
                <code>token</code>.</td>
              </tr>

              <tr>
                <td><code>client_id</code></td>

                <td>REQUIRED. The client identifier</td>
              </tr>

              <tr>
                <td><code>redirect_uri</code></td>

                <td>REQUIRED. Must match one of the client's
                pre-registered redirect URIs.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Must include
                <code>single-patient</code>, and may additionally
                include
                <code>http://siframework.org/ABBI/endpoint/search</code>
                and
                <code>http://siframework.org/ABBI/endpoint/summary</code></td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>RECOMMENDED. An opaque value used by the client
                to maintain state between the request and callback.
                The authorization server includes this value when
                redirecting the user-agent back to the client. The
                parameter SHOULD be used for preventing cross-site
                request forgery <span class="label label-warning">Should state be REQUIRED with a minimum level of entropy?</span></td>
              </tr>
            </table>

            <h5>Example App-to-Provider Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/authorize?
response_type=token&amp;
client_id=bp-grapher&amp;
redirect_uri=https%3A%2F%2Fbpgrapher.org%2Fafter-auth&amp;
scope=single-patient%20http%3A%2F%2Fsiframework.org%2FABBI%2Fendpoint%2Fsummary&amp;
state=98wrghuwuogerg97

Host: bbplus-provider.org 
</pre>

            <h3>2. Provider Authenticates Patient and Obtains
            Authorization</h3>The mechanism by which providers
            authenticate patients and obtain authorization is out
            of scope for this specification

            <h3>3. Provider-to-App Redirection</h3>

            <p>After a successful authorization step, the
            BlueButton+ provider redirects the browser to the app's
            <code>redirect_uri</code>, with the following
            parameters <strong>embedded in the URI's #fragment
            component</strong>.</p>

            <table class="table table-striped">
              <tr>
                <th>Parameter</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>access_token</code></td>

                <td>REQUIRED. The access token issued by the
                authorization server</td>
              </tr>

              <tr>
                <td><code>token_type</code></td>

                <td>REQUIRED. Fixed value: <code>bearer</code></td>
              </tr>

              <tr>
                <td><code>expires_in</code></td>

                <td>REQUIRED. The lifetime in seconds of the access
                token. For example, the value "3600" denotes that
                the access token will expire in one hour from the
                time the response was generated.</td>
              </tr>

              <tr>
                <td><code>scope</code></td>

                <td>REQUIRED. Scope of access authorized by the
                patient.</td>
              </tr>

              <tr>
                <td><code>state</code></td>

                <td>REQUIRED. The exact value received from the
                client.</td>
              </tr>
            </table>

            <h5>Example Provider-to-App Redirection (newlines added
            for clarity)</h5>
            <pre class="prettyprint">
/after-auth#
access_token=i8hweunweunweofiwweoijewiwe&amp;
token_type=bearer&amp;
expires_in=3600&amp;
scope=single-patient%20http%3A%2F%2Fsiframework.org%2FABBI%2Fendpoint%2Fsummary&amp;
state=98wrghuwuogerg97

Host: bbplus-provider.org 
</pre>
          </div>
        </section>

        <section id="discovery">
          <div class="page-header">
            <h1>Provider and App Discovery <small>via Trust Bundle
            Servers</small> <span class="label label-success">Common</span></h1>

            <p>BlueButton+ Pull uses <strong>Trust Bundle
            Servers</strong> to enable discovery of BB+ Providers
            and BB+ Apps. Each Trust Bundle Server exposes a set of
            trusted providers and a set of trusted apps at
            well-known <code>https</code> URLs, using simple
            <a href="http://json-ld.org/">JSON-LD</a> arrays. In
            the BB+ ecosystem, apps and providers must be
            pre-configured with a Trust Bundle Server (or
            Servers). All discovery endpoints are organized beneath <code>.well-known/bb/</code> at the server's root.</p>

            <h5>Why JSON-LD?</h5>

            <div class="well alert-info">
              <p><strong>JSON-LD</strong> provides a nice balance
              between idiomatic JSON and well-structured data
              representations. By combining a JSON payload with a
              JSON-LD context, properties can be expanded to full
              URIs so that data can be mixed and matched with other
              services. For example, the BB+ Provider element below
              can automatically be:</p>

              <ul>
                <li>
                  <a href="http://tinyurl.com/bpz5xsx" target=
                  "_blank">Expanded to full property URIs</a>
                </li>

                <li>
                  <a href="http://tinyurl.com/cp9vmum" target=
                  "_blank">Normalized in RDF</a>
                </li>
              </ul>
            </div>
            
            <h2 id="discovery-trustbundle">Trust Bundle Discovery</h2>
            
            <p>A Trust Bundle Server exposes a BB+ Trust Bundle discovery endpoint at: <code>/.well-known/bb/trustbundle.json</code></p>
            
            <h3>trustbundle.json</h3>
            
            <p><code>trustbundle.json</code> is a single TrustBundle element expressed as JSON-LD with a default
            <code>@vocab</code> from <a href=
            "http://schema.org">http://schema.org</a> and
            additional properties defined in the <a href=
            "context-json-ld.js">BB+ JSON-LD Context</a></p>
            
            <p>While any vocabulary from schema.org may be used in
            describing a trust bundle, the <strong>following fields are
            required:</strong></p>

            <table class="table table-striped">
              <tr>
                <th>Property</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>name</code></td>

                <td>Human-readable Name of the Trust Bundle</td>
              </tr>

              <tr>
                <td><code>url</code></td>

                <td>Root URL of the Trust Bundle</td>
              </tr>

              <tr>
                <td><code>jwks_uri</code></td>

                <td>URL to the JSON Web Key (JWK) set for this trust bundle</td>
              </tr>

              <tr>
                <td><code>oauth2</code></td>

                <td>Collection of OAuth2 endpoints</td>
              </tr>

              <tr>
                <td class="subproperty"><code>introspect</code></td>

                <td>RECOMMENDED OAuth2 introspection endpoint (As described in <a href="http://tools.ietf.org/html/draft-richer-oauth-introspection">this draft</a>)</td>
              </tr>
              
            </table>

            <h5>trustbundle.json example</h5>
            <pre class="prettyprint">
Content-Type: application/json
Link: &lt;http://jmandel.github.com/blue-button-plus-pull/context-json-ld.js&gt;; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

{
  "name": "The Trust Bundle Foundation",
  "url": "http://trustbundle.org/",
  "jwks_uri": "https://trustbundle.org/public_key.jwks",
  "oauth2": {
    "introspect": "https://trustbundle.org/oauth/introspect",
  }

}
            
</pre>            
              
            <h2 id="discovery-providers">Provider Discovery</h2>

            <p>A Trust Bundle Server exposes a BB+ Provider
            Discovery endpoint at:
            <code>/.well-known/bb/providers.json</code></p>

            <h3>providers.json</h3>

            <p><code>providers.json</code> is a JSON array of
            Provider elements, expressed as JSON-LD with a default
            <code>@vocab</code> from <a href=
            "http://schema.org">http://schema.org</a> and
            additional properties defined in the <a href=
            "context-json-ld.js">BB+ JSON-LD Context</a></p>

            <p>While any vocabulary from schema.org may be used in
            describing a provider, the <strong>following fields are
            required:</strong></p>

            <table class="table table-striped">
              <tr>
                <th>Property</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>name</code></td>

                <td>Name of the BB+ Data Provider organization</td>
              </tr>

              <tr>
                <td><code>url</code></td>

                <td>Primary url of the provider organization</td>
              </tr>

              <tr>
                <td><code>patient_signin</code></td>

                <td>URL where a patient can sign in to the
                Provider</td>
              </tr>

              <tr>
                <td><code>oauth2</code></td>

                <td>Collection of OAuth2 endpoints</td>
              </tr>

              <tr>
                <td class="subproperty"><code>authorize</code></td>

                <td>OAuth2 authorization endpoint</td>
              </tr>

              <tr>
                <td class="subproperty"><code>token</code></td>

                <td>OAuth2 token endpoint</td>
              </tr>

              <tr>
                <td class="subproperty"><code>introspect</code></td>

                <td>OAuth2 introspection endpoint (As described in <a href="http://tools.ietf.org/html/draft-richer-oauth-introspection">this draft</a>)</td>
              </tr>

              <tr>
                <td><code>bb_api</code></td>

                <td>Collection of BB+ API endpoints</td>
              </tr>

              <tr>
                <td class="subproperty"><code>summary</code></td>

                <td>BlueButton+ Clinical Summary endpoint</td>
              </tr>

              <tr>
                <td class="subproperty"><code>search</code></td>

                <td>BlueButton+ Document Search endpoint</td>
              </tr>
            </table>

            <h5>providers.json example</h5>
            <pre class="prettyprint">
Content-Type: application/json
Link: &lt;http://blue-button.github.com/blue-button-plus-pull/context-json-ld.js&gt;; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

[
{
  "name": "Good Health Clinic",
  "description": "Serving your health needs since 1999",
  "url": "http://goodhealthclinic.org",
  "patient_signin": "http://portal.goodhealthclinic.org",
  "location": {
    "geo": {                       
      "latitude": 42.3591,            # just making the point that we can
      "longitude": -71.0934           # use arbitrary schema.org properties
    }
  },
  "oauth2": {
    "authorize_uri": "http://portal.goodhealthclinic.org/authorize",
    "token_uri": "http://portal.goodhealthclinic.org/token"
  },
  "bb_api": {
    "summary": "http://api.goodhealthclinic.org/patient/documents/summary",
    "search": "http://api.goodhealthclinic.org/patient/documents/search"
  }
},
{
 ... (more providers here) ...
}
] 
</pre>

            <h2 id="discovery-apps">App Discovery</h2>

            <p>A Trust Bundle Server exposes a <strong>BB+ App
            Discovery</strong> endpoint at:
            <code>/.well-known/bb/apps.json</code></p>

            <h3>apps.json</h3>

            <p><code>apps.json</code> is a JSON array of App
            elements, expressed as JSON-LD with a default
            <code>@vocab</code> from <a href=
            "http://schema.org">http://schema.org</a> and
            additional properties defined in the <a href=
            "context-json-ld.js">BB+ JSON-LD Context</a></p>

            <p>While any vocabulary from schema.org may be used in
            describing a provider, the <strong>following fields are
            required:</strong></p>

            <table class="table table-striped">
              <tr>
                <th>Property</th>

                <th>Description</th>
              </tr>

              <tr>
                <td><code>name</code></td>

                <td>Name of the BB+ App</td>
              </tr>

              <tr>
                <td><code>url</code></td>

                <td>Primary url of the provider organization</td>
              </tr>

              <tr>
                <td><code>fixed_registration_parameters</code></td>

                <td>
                  JSON structure containing any <a href=
                  "#registration-parameters">registration
                  parameters</a> that are fixed across all
                  instances of this app. A Trusted Registration
                  request that fails to match (NOTE: need matching mechanisms defined here) on any
                  parameters included here will be rejected. 
                  This may contain any valid client metadata reistration parameters, and it is RECOMMENDED that the following ones be particularly locked down.
                </td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>client_name</code></td>

                <td>client_name must be fixed across all app
                instances and must match the schema.org name
                above</td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>client_uri</code></td>

                <td>client_uri must be fixed across all app
                instances and must match the schema.org url
                above</td>
              </tr>

              <tr>
                <td class="subproperty">
                <code>redirect_uris</code></td>

                <td>the set of allowable redirect_uris must be
                fixed across all app instances</td>
              </tr>
            </table>

            <h5>apps.json example</h5>
            <pre class="prettyprint">
Content-Type: application/json
Link: &lt;http://blue-button.github.com/blue-button-plus-pull/context-json-ld.js&gt;; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"

[
{
  "url": "https://bpgrapher.org",
  "name": "Blood Pressure Grapher",
  "fixed_registration_parameters": {
      "client_name": "Blood Pressure Grapher",
      "client_uri": "https://bpgrapher.org",
      "logo_uri": "http://bpgrapher.org/images/logo.png",
      "contacts": [
        "plot-master@bpgrapher.org"
      ],
      "tos_uri": "https://bpgrapher.org/tos",
      "redirect_uris": [
        "https://bpgrapher.org/after-auth"
      ],
      "response_types": ["token"],
      "grant_types": ["implicit"],
      "token_endpoint_auth_method": "none",
      "scope":  "single-patient http://siframework.org/ABBI/endpoint/summary"
  },
},
{
 ... (more apps here) ...
}
] 
</pre>
          </div>
        </section>

        <section id="push-authorization">
          <div class="page-header">
            <h1>User Authorization <span class="label label-warning">Push</span></h1>
            <p>
              Patient data is stored with many providers and manually requesting an update from each one can be difficult for a patient.
              It is expected that client applications will use this workflow to help the user find those providers and setup automation for receiving updates.
              This is the method for enabling the user to authorize their providers to send these notifications with their own health data.
            </p>

            <div class="well alert">
              <p>In this example, assume the user is interacting with this environment:
                <dl>
                  <dt>Client</dt>
                    <dd>BP-Grapher</dd>
                  <dt>Service Provider</dt>
                    <dd>Good Health Clinic</dd>
                  <dt>Scope</dt>
                    <dd><code>send-email-to</code> is a special, structured scope that is used to indicate the DIRECT email to send information to for this user</dd>
                </dl>
              </p>
            </div>
            
            <h3>User Authorization Flow:</h3>
            <p>
              In this section, we describe how a user can authorize a service provider to send updates them updates as new health data becomes available.
              To enable this process, the client must perform the following steps:
              <ol>
                <li>Discovery as described above (<a href="#discovery-providers">provider discovery</a> at its trust bundle).</li>
                <li>Search, filter, and optionally cache discovered service providers. The user will select one or more to authorize.</li>
                <li><a href="#registration-trusted">Dynamically register</a> if the client doesn't already have their OAuth 2 credentials for the chosen service provider.</li>
                <li>Send the user (in a web browser) to the service provider's authorization endpoint. They have the option to authorize this provider to push their data.</li>
                <li>Verify success by requesting a token from the service provider's token endpoint to ensure the user's selection succeeded.</li>
              </ol>
            </p>

            <h4>1. Discovery</h4>
            <p>
              Discovery for Push is the same process as shown above for <a href="#discovery-providers">provider discovery</a>.
              A provider's information, including endpoint URIs, will be served in the following format:
            </p>

<pre class="prettyprint">
{
  "name": "Good Health Clinic",
  "description": "Serving your health needs since 1999",
  "url": "http://goodhealthclinic.org",
  "patient_signin": "http://portal.goodhealthclinic.org",
  "location": {
    "geo": {                       
      "latitude": 42.3591,            # just making the point that we can
      "longitude": -71.0934           # use arbitrary schema.org properties
    }
  },
  "oauth2": {
    "authorize_uri": "http://portal.goodhealthclinic.org/authorize",
    "token_uri": "http://portal.goodhealthclinic.org/token"
  },
  "bb_api": {
    "summary": "http://api.goodhealthclinic.org/patient/documents/summary",
    "search": "http://api.goodhealthclinic.org/patient/documents/search"
  }
}
</pre>

            <h4>2. Search, filter, and cache</h4>
            <p>
              The specifics of client-side searching, filtering, caching, and selecting are out of scope for this guide.
              Part of the rationale for delegating this task to the client is that the implementation of these tasks may vary by platform
            </p>

            <h4>3. Dynamic registration</h4>
            <p>
              Dynamic registration for Push is the same process as <a href="#registration-trusted">shown above</a>.
              This step retrieves a client_id and client_secret for this specific service provider. These values may and likely will vary across providers.
              If the client has already retrieved the client's ID and secret, this step can be skipped.
              Below is an example of the metadata sent in a request for dynamic registration and the response received.
            </p>

<p>Dynamic registration request:</p>
<pre class="prettyprint">
{
  "url": "https://bpgrapher.org",
  "name": "Blood Pressure Grapher",
  "fixed_registration_parameters": {
    "client_name": "Blood Pressure Grapher",
    "client_uri": "https://bpgrapher.org",
    "logo_uri": "http://bpgrapher.org/images/logo.png",
    "contacts": [
      "plot-master@bpgrapher.org"
    ],
    "tos_uri": "https://bpgrapher.org/tos",
    "redirect_uris": [
      "https://bpgrapher.org/after-auth"
    ],
    "response_types": ["code"],
    "grant_types": ["authorization_code"],
    "token_endpoint_auth_method": "none",
    "scope":  "send-email-to"
  },
}
</pre>
<p>Dynamic registration response:</p>
<pre class="prettyprint">
{
  "client_id": "bp-grapher-goodhealth",
  "client_secret": "aser98uw4ijhsdfg9r4",
  "registration_access_token": "2398askljasdf.gjo23r98adsf.asdf8923uwekljashdf7892334",
  "client_name": "Blood Pressure Grapher",
  "client_uri": "https://bpgrapher.org",
  "logo_uri": "http://bpgrapher.org/images/logo.png",
  "contacts": [
    "plot-master@bpgrapher.org"
  ],
  "tos_uri": "https://bpgrapher.org/tos",
  "redirect_uris": [
    "https://bpgrapher.org/after-auth"
  ],
  "response_types": ["code"],
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "none",
  "scope":  "send-email-to"
}
</pre>

            <h4>4. Authorization request</h4>
            <p>
              By this step, the client has its OAuth 2 credentials. The client will use that data to send the user to the service provider's authorization endpoint.
              Below is an example authorization request for the code workflow (more information is available in OAuth 2 RFC 6749 Section 4.1):
            </p>

<pre class="prettyprint">
http://portal.goodhealthclinic.org/authorize
  &response_type=code
  &client_id=bp-grapher-goodhealth
  &redirect_uri=https://bpgrapher.org/after-auth
  &state=aliawejhwiluaq34hiuow
  &scope=send_email_to:oip8erjoiaewjoi@direct.bp-grapher.org
</pre>

            <div class="well alert">
              <p>
                <strong>Note:</strong> The send_email_to scope construct above is asking for permission to send e-mail to the given address after the :, using a simple expression language as part of the structured scope.
              </p>
            </div>

            <p>
              At this point, the client will receive either a positive response or a failure. Hypothetically, this response reflects the ultimate results, but
              the next step addresses the client's ability to verify this response
            </p>

<p>Positive response:
Client is redirected to:
</p>
<pre class="prettyprint">
https://bpgrapher.org/after-auth
  &state=aliawejhwiluaq34hiuow
  &code=oafea8i23n
</pre>

<p>Error response: (e.g. user clicked deny):</p>
<pre class="prettyprint">
https://bpgrapher.org/after-auth
  &state=aliawejhwiluaq34hiuow
  &error=access_denied (Other error codes are available from 4.1.2.1)
</pre>

            <h4>5. Verify authorization results</h4>
            <p>
              To verify that the code we got is real, we request a token using the code from the token endpoint.
              If this returns an access token (and not an error), then we know the code we used was good and that the user actually aubbthorized for us.
              Optionally, the client can also check the scope of the returned token to ensure that the requested scopes were received.
              Below is an example of the request for this verification:
            </p>

<pre class="prettyprint">
http://portal.goodhealthclinic.org/token
  &client_id=bp-grapher-goodhealth
  &client_secret=aser98uw4ijhsdfg9r4
  &redirect_uri=https://bpgrapher.org/after-auth
  &grant_type=code
  &code=oafea8i23n
</pre>

	  <p>The server then returns the token structure as follows:</p>
	  
<pre class="prettyprint">
{
  "access_token": "i8hweunweunweofiwweoijewiwe",
  "token_type": "bearer",
  "expires_in": "3600",
  "scope": "send_email_to:oip8erjoiaewjoi@direct.bp-grapher.org"
} 
</pre>

          </div>
          
          
          <div class="well alert-info"><h1>Alternative Push Authorization <span class="label label-warning">Push</span></h1>An alternative to this whole approach would be to have the Client be Good Health Clinic and the Provider be BP-Grapher, with the protected data being the email address to send things to. This is more in line with OAuth's REST-friendly model and the traditional definition of roles, but it doesn't fit as well with the PUSH methods we're trying to enable here.</div>
          
        </section>
      </div>
    </div>
  </div><!-- Footer
        ================================================== -->

  <footer class="footer">
    <div class="container">
      <p>Automate Blue Button Initiative 2013</p>
    </div>
  </footer><!-- Le javascript
        ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="./assets/js/jquery.js">
</script> <script src="./assets/js/bootstrap-transition.js">
</script> <script src="./assets/js/bootstrap-alert.js">
</script> <script src="./assets/js/bootstrap-modal.js">
</script> <script src="./assets/js/bootstrap-dropdown.js">
</script> <script src="./assets/js/bootstrap-tab.js">
</script> <script src="./assets/js/bootstrap-tooltip.js">
</script> <script src="./assets/js/bootstrap-popover.js">
</script> <script src="./assets/js/bootstrap-button.js">
</script> <script src="./assets/js/bootstrap-collapse.js">
</script> <script src="./assets/js/bootstrap-affix.js">
</script> <script src="./assets/js/bootstrap-scrollspy.js">
</script> <script src="./assets/js/bootstrap-carousel.js">
</script> <script src="./assets/js/bootstrap-typeahead.js">
</script> <script src="./assets/js/holder.js">
</script> <script src="./assets/js/prettify.js">
</script> <script src="./assets/js/application.js">
</script>
</body>
</html>
